# Deep Researcher ç®€åŒ– Makefile
# æä¾›ä¾¿æ·çš„Dockeræ“ä½œå‘½ä»¤

.PHONY: help build up dev down logs clean backup shell status health setup

# Docker Composeæ–‡ä»¶è·¯å¾„
COMPOSE_FILE = deploy/docker/docker-compose.yml
COMPOSE_DEV_FILE = deploy/docker/docker-compose.dev.yml

# é»˜è®¤ç›®æ ‡
help:
	@echo "Deep Researcher ç®€åŒ–æ“ä½œå‘½ä»¤:"
	@echo ""
	@echo "  build     - æ„å»ºDockeré•œåƒ"
	@echo "  up        - å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ"
	@echo "  dev       - å¯åŠ¨å¼€å‘ç¯å¢ƒ"
	@echo "  down      - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  restart   - é‡å¯æœåŠ¡"
	@echo "  logs      - æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "  status    - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  clean     - æ¸…ç†å®¹å™¨å’Œé•œåƒ"
	@echo "  backup    - å¤‡ä»½ç ”ç©¶æ•°æ®"
	@echo "  shell     - è¿›å…¥å®¹å™¨shell"
	@echo "  health    - æ£€æŸ¥æœåŠ¡å¥åº·"
	@echo "  setup     - åˆå§‹åŒ–ç¯å¢ƒé…ç½®"
	@echo "  help      - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"

# æ„å»ºé•œåƒ
build:
	@echo "æ„å»ºDockeré•œåƒ..."
	docker-compose -f $(COMPOSE_FILE) build --no-cache

# ç”Ÿäº§ç¯å¢ƒ
up:
	@echo "å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ..."
	docker-compose -f $(COMPOSE_FILE) up -d
	@echo "ç”Ÿäº§ç¯å¢ƒå·²å¯åŠ¨!"
	@echo "å‰ç«¯: http://localhost:8501"
	@echo "API: http://localhost:8000"

# å¼€å‘ç¯å¢ƒ
dev:
	@echo "å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	docker-compose -f $(COMPOSE_FILE) -f $(COMPOSE_DEV_FILE) up -d
	@echo "å¼€å‘ç¯å¢ƒå·²å¯åŠ¨!"
	@echo "å‰ç«¯: http://localhost:8501"
	@echo "API: http://localhost:8000"

# åœæ­¢æœåŠ¡
down:
	@echo "åœæ­¢æ‰€æœ‰æœåŠ¡..."
	docker-compose -f $(COMPOSE_FILE) down
	docker-compose -f $(COMPOSE_FILE) -f $(COMPOSE_DEV_FILE) down 2>/dev/null || true

# é‡å¯æœåŠ¡
restart:
	@echo "é‡å¯æœåŠ¡..."
	docker-compose -f $(COMPOSE_FILE) restart

# æŸ¥çœ‹æ—¥å¿—
logs:
	docker-compose -f $(COMPOSE_FILE) logs -f

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	docker-compose -f $(COMPOSE_FILE) ps

# æ¸…ç†èµ„æº
clean:
	@echo "æ¸…ç†Dockerèµ„æº..."
	docker-compose -f $(COMPOSE_FILE) down --volumes --rmi all
	docker system prune -f

# æ·±åº¦æ¸…ç†
clean-all:
	@echo "æ·±åº¦æ¸…ç†Dockerèµ„æº..."
	docker-compose -f $(COMPOSE_FILE) down --volumes --rmi all
	docker system prune -a -f --volumes

# å¤‡ä»½æ•°æ®
backup:
	@echo "å¤‡ä»½ç ”ç©¶ç»“æœ..."
	mkdir -p backup/$(shell date +%Y%m%d_%H%M%S)
	docker cp deep-researcher-app:/app/research_result backup/$(shell date +%Y%m%d_%H%M%S)/ 2>/dev/null || \
	cp -r research_result backup/$(shell date +%Y%m%d_%H%M%S)/
	@echo "å¤‡ä»½å®Œæˆ: backup/$(shell date +%Y%m%d_%H%M%S)/"

# è¿›å…¥å®¹å™¨shell
shell:
	docker-compose -f $(COMPOSE_FILE) exec deep-researcher /bin/bash

# æ›´æ–°åº”ç”¨
update:
	@echo "æ›´æ–°åº”ç”¨..."
	git pull origin main
	make down
	make build
	make up
	@echo "æ›´æ–°å®Œæˆ!"

# æŸ¥çœ‹èµ„æºä½¿ç”¨
stats:
	docker stats $(shell docker-compose -f $(COMPOSE_FILE) ps -q)

# æ£€æŸ¥å¥åº·çŠ¶æ€
health:
	@echo "æ£€æŸ¥APIå¥åº·çŠ¶æ€..."
	curl -f http://localhost:8000/health || echo "APIæœåŠ¡å¼‚å¸¸"
	@echo "æ£€æŸ¥å‰ç«¯çŠ¶æ€..."
	curl -f http://localhost:8501 > /dev/null || echo "å‰ç«¯æœåŠ¡å¼‚å¸¸"

# ç¯å¢ƒé…ç½®
setup:
	@echo "åˆå§‹åŒ–ç¯å¢ƒé…ç½®..."
	@if [ ! -f .env ]; then \
		cp deploy/configs/env.example .env; \
		echo "å·²åˆ›å»º.envæ–‡ä»¶ï¼Œè¯·ç¼–è¾‘é…ç½®åå†å¯åŠ¨æœåŠ¡"; \
	else \
		echo ".envæ–‡ä»¶å·²å­˜åœ¨"; \
	fi
	mkdir -p research_result/cache research_result/reports

# ç”Ÿäº§éƒ¨ç½²å‰æ£€æŸ¥
pre-deploy:
	@echo "éƒ¨ç½²å‰æ£€æŸ¥..."
	@if grep -q "your_openai_api_key_here" .env; then \
		echo "âŒ è¯·é…ç½®OPENAI_API_KEY"; \
		exit 1; \
	fi
	@echo "âœ… é…ç½®æ£€æŸ¥é€šè¿‡"

# å¿«é€Ÿå¯åŠ¨ï¼ˆæ¨èç”¨äºæ–°æ‰‹ï¼‰
quick-start: setup pre-deploy up
	@echo "ğŸš€ å¿«é€Ÿå¯åŠ¨å®Œæˆ!"
	@echo "è®¿é—® http://localhost:8501 å¼€å§‹ä½¿ç”¨"
